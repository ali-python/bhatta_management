{% extends 'base.html' %}
{% block worker %}active{% endblock %}
{% block worker_home %}active{% endblock %}{% block content %}
<div class="content-wrapper">
    <section class="content-header">
        <ol class="breadcrumb">
            <li><a href="{% url 'worker:home' %}"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">{% if object %}اپڈیٹ{% else %}سالانہ حساب{% endif %}</li>
        </ol>
    </section>
    <br>

    <section class="content">
        <div class="box">
            <div class="box-header text-center">
                <h4><b>{% if object %}اپڈیٹ{% else %}سالانہ حساب{% endif %}</b></h4>
            </div>
            <div class="box-body">
                <form method="post">
                    {% csrf_token %}

                    <!-- Worker, Bhatta, Year -->
                    <div class="row">
                        <div class="col-md-4 form-group">
                            <label>مزدور <span style="color:red">*</span></label>

                            <input type="text" class="form-control" value="{{ selected_worker.name }} " disabled>
                            <input type=hidden name="worker" value="{{ selected_worker.id}}">
                        </div>
                        <div class="col-md-4 form-group">
                            <label>بھٹہ <span style="color:red">*</span></label>
                            <input type="hidden"  name="bhatta" value="{{ selected_bhatta.id }}">
                            <input type="text" class="form-control"  value="{{ selected_bhatta.name }}" disabled>
                        </div>
                        <div class="col-md-4 form-group">
                            <label>سال <span style="color:red">*</span></label>
                            <input type="number" name="year" class="form-control" value="{{ year }}" required>
                        </div>
                    </div>

                    <!-- Brick Rate, Total Advance, Total Loan -->
                    <div class="row">
                        <div class="col-md-3 form-group">
                            <label>ہزار اِینٹ کا ریٹ  <span style="color:red">*</span></label>
                            <input type="number" step="0.01" name="brick_rate" id="brick_rate" class="form-control"
                                   value="{{ brick_rate|default:0 }}" required>
                        </div>
                        <div class="col-md-3 form-group">
                            <label>ٹوٹل خرچہ </label>
                            <input type="number" step="0.01" class="form-control" id="total_advance" disabled value="{{ total_advance }}">
                            <input type="hidden" name="total_advance" id="hidden_total_advance" value="{{ total_advance }}">
                        </div>
                        <div class="col-md-3 form-group">
                            <label>ٹوٹل پیشگی</label>
                            <input type="number" step="0.01" class="form-control" disabled value="{{ total_loan }}">
                        </div>
                        <div class="col-md-3 form-group">
                            <label>پیشگی کٹوتی</label>
                            <input type="number" step="0.01" class="form-control" id="total_loan" name="total_loan_deducted" value="0">
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="row">
                        <div class="col-md-4 form-group">
                            <label>ٹوٹل اِینٹ</label>
                            <input type="number" class="form-control" id="total_bricks" disabled value="{{ total_bricks }}">
                        </div>
                        <div class="col-md-4 form-group">
                            <label>ٹوٹل کمائی</label>
                            <input type="number" class="form-control" id="total_earned" disabled value="{{ total_earned|default:0 }}">
                        </div>
                        <div class="col-md-4 form-group">
                            <label>ادائیگی کے لیے رقم</label>
                            <input type="number" class="form-control" id="amount_to_pay" name="amount_to_pay" disabled value="{{ amount_to_pay|default:0 }}">
                        </div>
                    </div>

                    <!-- Payment Made -->
                    <div class="row">
                        <div class="col-md-4 form-group">
                            <label>ادائیگی کی گئی</label>
                            <input type="number" step="0.01" name="payment_made" class="form-control"
                                   value="{{ payment_made|default:0 }}">
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="row mt-2">
                        <div class="col-md-2 form-group">
                            <button type="submit" class="btn btn-primary form-control">
                                {% if object %}Update{% else %}Calculate & Save{% endif %}
                            </button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </section>
</div>

<!-- JavaScript to update Total Earned and Amount To Pay -->
<script>
    // document.addEventListener('DOMContentLoaded', function() {
    // const totalAdvanceHidden = document.getElementById('hidden_total_advance');
    // const totalAdvanceDisplay = document.getElementById('total_advance');

    // function updateTotals() {
    //     const rate = parseFloat(brickRateInput.value) || 0;
    //     const loanDeduct = parseFloat(totalLoanInput.value) || 0;

    //     const earned = (totalBricks / 1000) * rate;
    //     const toPay = earned - totalAdvance - loanDeduct;

    //     totalEarnedInput.value = earned.toFixed(2);
    //     amountToPayInput.value = toPay.toFixed(2);

    //     // VERY IMPORTANT — Update hidden field
    //     totalAdvanceHidden.value = totalAdvanceDisplay.value;
    // }

    // brickRateInput.addEventListener('input', updateTotals);
    // totalLoanInput.addEventListener('input', updateTotals);

    // updateTotals();
// });

document.addEventListener('DOMContentLoaded', function() {
    const brickRateInput = document.getElementById('brick_rate');
    const totalBricks = parseFloat(document.getElementById('total_bricks').value) || 0;
    const totalAdvance = parseFloat(document.getElementById('total_advance').value) || 0;
    const totalLoanInput = document.getElementById('total_loan'); // user entered loan deduct

    const totalEarnedInput = document.getElementById('total_earned');
    const amountToPayInput = document.getElementById('amount_to_pay');

    function updateTotals() {
        const rate = parseFloat(brickRateInput.value) || 0;
        const loanDeduct = parseFloat(totalLoanInput.value) || 0;

        // Total Earned
        const earned = (totalBricks / 1000) * rate;

        // Amount to Pay = Earned - Advance - Loan Deducted
        const toPay = earned - totalAdvance - loanDeduct;

        totalEarnedInput.value = earned.toFixed(2);
        amountToPayInput.value = toPay.toFixed(2);
        totalAdvanceHidden.value = totalAdvanceDisplay.value;

    }

    brickRateInput.addEventListener('input', updateTotals);
    totalLoanInput.addEventListener('input', updateTotals);

    updateTotals(); // Initial calculation
});
</script>


{% endblock %}
